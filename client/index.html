<!DOCTYPE html>
<html>
<head>
 <meta charset="utf-8">
 <title>Adventure</title>
 <link rel="stylesheet" href="css/normalize.css">
 <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div id="content" class="full"></div>
  <script src="react/build/react.min.js"></script>
  <script src="react/build/JSXTransformer.js"></script>
  <script src="data/story.js"></script>
  <script src="http://code.responsivevoice.org/responsivevoice.js"></script>
  <script type="text/jsx">

var colors = {
  blue:"#79b5d2",
  red:"#d27979",
  violet:"#d279d2",
  green:"#97d279",
  yellow:"#97d279",
  blueLight:"#33b5e5",
  blueDark:"#0099cc",
  blueBright:"#00ddff",
} //=>use this:http://www.google.fr/design/spec/style/color.html

var Box = React.createClass({
  render:function(){
    var style={
      backgroundColor:colors[this.props.color]
    }
    return <div
      className="box"
      style={style}
      onClick={this.props.onClick}
      >
      <span className="backtext">{this.props.backText}</span>
      <div className="center">
        <span className="text">{this.props.text}</span>
      </div>
      </div>
  }
})

var Grid = React.createClass({
  render:function(){
    var choices = this.props.choices;
    return (<div className="full">
          {choices.A}
          {choices.B}
          {choices.C}
          {choices.D}
        </div>);
  }    
})

var PauseMenu = React.createClass({
  goBack:function(){
    this.props.toogleMenu();
    window.history.back();
  },
  exit:function(){
    window.location.hash = ""
  },
  render: function(){
    choices = {
      A: (<Box color="blue" text="REPEAT"
        onClick={this.props.toogleMenu} />),
      B: (<Box color="red" text="UNDO"
        onClick={this.goBack}/>),
      C: (<Box color="red" text="EXIT"
        onClick={this.exit}/>),
      D: (<Box color="blue" text="CONTINUE"
        onClick={this.props.toogleMenu} />)
    }
    return <Grid choices={choices} />;
  }
})

var Story = React.createClass({
  getInitialState: function(){
    return {showMenu:false}
  },
  toogleMenu: function(e){
    responsiveVoice.cancel();
    this.setState({showMenu:!this.state.showMenu});
  },
  render: function() {
    if(this.state.showMenu){
      return <PauseMenu toogleMenu={this.toogleMenu}/>
    }
    var now = this.props.story[this.props.state];
    document.title = now.text
    var voice = "French Female";
    if(now.voice != undefined){
      voice = now.voice;
    }
    responsiveVoice.speak(now.text, voice);
    var box = function(i,color, backtext){
      if(now.choices.length > i){
        var choice = now.choices[i];
        return (<Box
          color={color}
          onClick={this.props.onStateChanged.bind(null,choice.next)}
          text={choice.message}
          backText={backtext}/>)
      }
      return <Box color={color} />
    }.bind(this)
    var choices = {
      A: box(0,"red","A"),
      B: box(1,"green","B"),
      C: box(2,"blue","C"),
      D: <Box color="violet" text="MENU"
        onClick={this.toogleMenu}/>,
    }
    return <Grid choices={choices} />;
  }
  })


var Menu = React.createClass({
  render: function(){
    choices = {
      A: (<Box color="blueLight" text="Adventure"/>),
      B: (<Box color="blueDark" text="START"
          onClick={this.props.changeState.bind(null,'<select>')}/>),
      C: (<Box color="blueDark" text="LIBRARY"/>),
      D: (<Box color="blueLight" text="CONTRIBUTE"/>)
    };
    return <Grid choices={choices} />;
  }
})

var Select = React.createClass({
  render: function(){
    choices = {
      A: (<Box color="blueLight" text="Camille"
          onClick={this.props.changeState.bind(null,'start')}/>),
      B: (<Box color="blueDark" text="Tea time"
          onClick={this.props.changeState.bind(null,'start')}/>),//lol
      C: (<Box color="blueDark" text=""/>),
      D: (<Box color="blueLight" text=""/>)
    };
    return <Grid choices={choices} />;
  }
})

var App = React.createClass({
  changeState: function(next){
    responsiveVoice.cancel();
    window.location.hash = next;
  },
  render: function() {
    if(this.props.state == '<menu>'){
      return <Menu changeState={this.changeState}/>
    }
    if(this.props.state == '<select>'){
      return <Select changeState={this.changeState}/>
    }
    return (<div className="full">
      <Story story={__STORIES__["Camille"]} state={this.props.state}
        onStateChanged={this.changeState}/>
    </div>);
  }
});


function render () {
  var route = window.location.hash.substr(1);
  if(route == ''){
    route = "<menu>";
  }
  console.log('route',route)
  React.render(
    <App state={route}/>,
    document.getElementById('content')
    );
}

window.addEventListener('hashchange', render);
setTimeout(render, 0); //1000 for the first speech to work, 0 if you don't care
  </script>
</body>
</html>