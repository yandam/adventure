<!DOCTYPE html>
<html>
<head>
 <meta charset="utf-8">
 <title>Adventure</title>
 <link rel="stylesheet" href="css/normalize.css">
 <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div id="content" class="full"></div>
  <script src="react/build/react.min.js"></script>
  <script src="react/build/JSXTransformer.js"></script>
  <script src="data/story.js"></script>
  <script src="http://code.responsivevoice.org/responsivevoice.js"></script>
  <script type="text/jsx">

changeURL = function(next){
  responsiveVoice.cancel();
  window.location.hash = next;
}

var colors = {
  blue: "#33b5e5",
  gray: "rgba(99,99,99,51)",
  green: "#99cc00",
  red: "#ff4444",
  blue_dark: "#0099cc",
  green_dark: "#669900",
  red_dark: "#cc0000",
  purple: "#aa66cc",
  orange: "#ffbb33",
  orange_dark: "#ff8800",
  blue_bright: "#00ddff",
  gray_bright: "rgba(204,204,204,51)",
} //=>use this:http://www.google.fr/design/spec/style/color.html

var Box = React.createClass({
  render:function(){
    var style={
      backgroundColor:colors[this.props.color]
    }
    return <div
      className="box"
      style={style}
      onClick={this.props.onClick}
      onTouchStart={this.props.onClick}
      >
      <span className="backtext">{this.props.backText}</span>
      <div className="center">
        <span className="text">{this.props.text}</span>
      </div>
      </div>
  }
})

var Grid = React.createClass({
  render:function(){
    var choices = this.props.choices;
    return (<div className="full">
          {choices.A}
          {choices.B}
          {choices.C}
          {choices.D}
        </div>);
  }    
})

var PauseMenu = React.createClass({
  goBack:function(){
    this.props.toogleMenu();
    window.history.back();
  },
  exit:function(){
    window.location.hash = ""
  },
  render: function(){
    choices = {
      A: (<Box color="green" text="REPEAT"
        onClick={this.props.toogleMenu} />),
      B: (<Box color="green_dark" text="UNDO"
        onClick={this.goBack}/>),
      C: (<Box color="green_dark" text="EXIT"
        onClick={this.exit}/>),
      D: (<Box color="green" text="CONTINUE"
        onClick={this.props.toogleMenu} />)
    }
    return <Grid choices={choices} />;
  }
})

var Story = React.createClass({
  getInitialState: function(){
    return {showMenu:false}
  },
  toogleMenu: function(e){
    responsiveVoice.cancel();
    this.setState({showMenu:!this.state.showMenu});
  },
  render: function() {
    if(this.state.showMenu){
      return <PauseMenu toogleMenu={this.toogleMenu}/>
    }
    var now = this.props.story[this.props.state];
    document.title = now.text
    var voice = this.props.story._settings.voice || 'UK English Female';
    if(now.voice != undefined){
      voice = now.voice;
    }
    responsiveVoice.speak(now.text, voice);
    var box = function(i,color, backtext){
      if(now.choices.length > i){
        var choice = now.choices[i];
        return (<Box
          color={color}
          onClick={changeURL
            .bind(null, this.props.story_key+"/"+choice.next)}
          text={choice.message}
          backText={backtext}/>)
      }
      return <Box color={color} />
    }.bind(this)
    var choices = {
      A: box(0,"blue","A"),
      B: box(1,"green","B"),
      C: box(2,"orange","C"),
      D: <Box color="red" text="MENU"
        onClick={this.toogleMenu}/>,
    }
    return <Grid choices={choices} />;
  }
  })


var Menu = React.createClass({
  render: function(){
    choices = {
      A: (<Box color="blue" text="Adventure"/>),
      B: (<Box color="blue_dark" text="LIBRARY"
          onClick={changeURL.bind(null,'select')}/>),
      C: (<Box color="blue_dark" text="MAKE YOUR OWN"
        onClick={changeURL.bind(null,'editor')}/>),
      D: (<Box color="blue" text=""/>),
    };
    return <Grid choices={choices} />;
  }
})

var Select = React.createClass({
  render: function(){
    var stories_keys = Object.keys(__STORIES__).sort()
    var box = function(i,color, backtext){
      if(stories_keys.length > i){
        var key = stories_keys[i];
        var story = __STORIES__[key];
        return (<Box
          color={color}
          onClick={changeURL.bind(null,key)}
          text={story._settings.title}
          backText={backtext}/>)
      }
      return <Box color={color} />
    }.bind(this)
    choices = {
      A: box(0,"red_dark",""),
      B: box(1,"red",""),
      C: box(2,"red",""),
      D: box(3,"red_dark",""),
    };
    return <Grid choices={choices} />;
  }
})

var Message = React.createClass({
  render: function(){
    return <pre>  <h1>  {this.props.children}</h1></pre>
  }
})

var Editor = React.createClass({
  render: function(){
    return <Message>Editor coming soon!</Message>
  }
})

var App = React.createClass({
  render: function() {
    var route = this.props.route.split('/');
    console.log('route', route)
    if(route[0] == ''){
      route[0] = 'menu';
    }
    if(route[0] == 'menu'){
      return <Menu />
    }
    if(route[0] == 'select'){
      return <Select />
    }
    if(route[0] in __STORIES__){
      var story = __STORIES__[route[0]];
      console.log('story',story)
      if(route[0] == 'editor'){
        return <Editor story={story} />
      }
      var state = "start"
      if(route.length > 1 && route[1] != ''){
        state = route[1];
      }
      if(state in story){
          return (<div className="full">
            <Story story={story} story_key={route[0]} state={state} />
          </div>);
      }
      return <Message>state {state} isn't in story!</Message>
    }
    return <Message>URL {route} is bad!</Message>
  }
});


function render () {
  var route = window.location.hash.substr(1);
  React.render(
    <App route={route}/>,
    document.getElementById('content')
    );
}

React.initializeTouchEvents(true)
window.addEventListener('hashchange', render);
//TODO: 1000ms timeout for the first speech to work
render();
  </script>
</body>
</html>