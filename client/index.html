<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Adventure</title>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="content" class="full"></div>
    <script type="text/javascript" src="js/vunit.js"></script>
    <script type="text/javascript" src="js/apiAndroid.js"></script>
    <script type="text/javascript" src="js/hacks.js"></script>
    <script src="react/build/react.min.js"></script>
    <script src="react/build/JSXTransformer.js"></script>
    <script src="data/story.js"></script>
    <!-- <script type="text/jsx" src="js/editor.js"></script> -->
    <script type="text/jsx">

text2speech = {
  cancel:function(){

  },
  speak:function(text){
    if ('speechSynthesis' in window) {
      var msg = new SpeechSynthesisUtterance(text);
      window.speechSynthesis.speak(msg);
    }else{
      console.log('FAKE SPEAK',text);
    }
  },
};

changeURL = function(next){
  text2speech.cancel();
  window.location.hash = next;
}

var colors = {
  blue: "#33b5e5",
  gray: "rgba(99,99,99,51)",
  green: "#99cc00",
  red: "#ff4444",
  blue_dark: "#0099cc",
  green_dark: "#669900",
  red_dark: "#cc0000",
  purple: "#aa66cc",
  orange: "#ffbb33",
  orange_dark: "#ff8800",
  blue_bright: "#00ddff",
  gray_bright: "rgba(204,204,204,51)",
} //=>use this:http://www.google.fr/design/spec/style/color.html

var Box = React.createClass({
  select:function(e){
    e.stopPropagation(); e.preventDefault();
    if(this.props.onClick){
      this.props.onClick(e)
    }
  },
  render:function(){
    var style={
      backgroundColor:colors[this.props.color]
    }
    return <div
      className="box"
      style={style}
      onClick={this.select}
      //onTouchStart={this.select}
      >
      <div className="center">
        <span className="text">{this.props.text}</span>
      </div>
      <span className="backtext">{this.props.backText}</span>
      </div>
  }
})

var EndScreen = React.createClass({
  render:function(){
    var choices = this.props.choices;
    return (<div className="full">
        The End
        </div>);
  }    
})

var Grid = React.createClass({
  render:function(){
    var choices = this.props.choices;
    return (<div className="full">
          {choices.A}
          {choices.B}
          {choices.C}
          {choices.D}
        </div>);
  }    
})

var PauseMenu = React.createClass({
  goBack:function(){
    this.props.toogleMenu();
    window.history.back();
  },
  exit:function(){
    window.location.hash = ""
  },
  render: function(){
    choices = {
      A: (<Box color="green" text="Repeat"
        onClick={this.props.toogleMenu}
        backText="🔊" />),
      B: (<Box color="green_dark" text="Exit"
        onClick={this.exit}
        backText="🏱" />),
      C: (<Box color="green_dark" text="Undo"
        onClick={this.goBack}
        backText="💢" />),
      D: (<Box color="green" text="Continue"
        onClick={this.props.toogleMenu}
        backText="📖" />)
    }
    return <Grid choices={choices} />;
  }
})

var Story = React.createClass({
  getInitialState: function(){
    return {showMenu:false}
  },
  toogleMenu: function(e){
    text2speech.cancel();
    this.setState({showMenu:!this.state.showMenu});
  },
  render: function() {
    if(this.state.showMenu){
      return <PauseMenu toogleMenu={this.toogleMenu}/>
    }
    var now = this.props.story[this.props.state];
    document.title = now.text
    var voice = this.props.story._settings.voice || 'UK English Female';
    if(now.voice != undefined){
      voice = now.voice;
    }
    text2speech.speak(now.text, voice);

    if(now.choices.length == 0){
      return <EndScreen />;
    }

    var box = function(i,color, backtext){
      if(now.choices.length > i){
        var choice = now.choices[i];
        return (<Box
          color={color}
          onClick={changeURL
            .bind(null, this.props.story_key+"/"+choice.next)}
          text={choice.message}
          backText={backtext}/>)
      }
      return <Box color={color} />
    }.bind(this)
    var choices = {
      A: box(0,"blue","A"),
      B: box(1,"green","B"),
      C: box(2,"orange","C"),
      D: <Box color="red" text="Menu"
        onClick={this.toogleMenu}
        backText="⏸"/>,
    }
    return <Grid choices={choices} />;
  }
  })


var Menu = React.createClass({
  render: function(){
    choices = {
      A: (<Box color="blue" text="Adventure"/>),
      B: (<Box color="blue_dark" text="Library"
          onClick={changeURL.bind(null,'select')}
          backText="📚" />),
      C: (<Box color="blue_dark" text=""/>),
      D: (<Box color="blue" text=""/>),
    };

    if(!window.androidApp)
    {
      choices['C'] = (<Box color="blue_dark" text="Editor"
        onClick={changeURL.bind(null,'editor')}
        backText="🖋" />);
    }
    
    return <Grid choices={choices} />;
  }
})

var Select = React.createClass({
  render: function(){
    var stories_keys = Object.keys(__STORIES__).sort()
    var box = function(i,color, backtext){
      if(stories_keys.length > i){
        var key = stories_keys[i];
        var story = __STORIES__[key];
        return (<Box
          color={color}
          onClick={changeURL.bind(null,key)}
          text={story._settings.title}
          backText={story._settings.icon}/>)
      }
      return <Box color={color} />
    }.bind(this)
    choices = {
      A: box(0,"red_dark",""),
      B: box(1,"red",""),
      C: box(2,"red",""),
      D: box(3,"red_dark",""),
    };
    return <Grid choices={choices} />;
  }
})

var Message = React.createClass({
  render: function(){
    return <pre>  <h1>  {this.props.children}</h1></pre>
  }
})

var App = React.createClass({
  render: function() {
    var route = this.props.route.split('/');
    console.log('route parts', route.join('--'))
    if(route[0] == ''){
      route[0] = 'menu';
    }
    if(route[0] == 'menu'){
      return <Menu />
    }
    if(route[0] == 'select'){
      return <Select />
    }
    if(route[0] == 'json'){
      return <pre>{JSON.stringify(__STORIES__,null,2)}</pre>
    }
    if(route[0] == 'editor'){
      return <Editor stories={__STORIES__} route={route} />
    }
    if(route[0] in __STORIES__){
      var story = __STORIES__[route[0]];
      console.log('story',story)
      var state = "start"
      if(route.length > 1 && route[1] != ''){
        state = route[1];
      }
      if(state in story){
          return (<div className="full">
            <Story story={story} story_key={route[0]} state={state} />
          </div>);
      }
      return <Message>state {state} isn't in story!</Message>
    }
    return <Message>URL {route} is bad!</Message>
  }
});


function render () {
  var route = window.location.hash.substr(1);
  React.render(
    <App route={route}/>,
    document.getElementById('content')
    );
}

React.initializeTouchEvents(true)
window.addEventListener('hashchange', render);
//TODO: 1000ms timeout for the first speech to work
render();
  </script>
</body>
</html>