<!DOCTYPE html>
<html>
<head>
 <meta charset="utf-8">
 <title>Adventure</title>
 <link rel="stylesheet" href="css/normalize.css">
 <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div id="content" class="full"></div>
  <script src="react/build/react.min.js"></script>
  <script src="react/build/JSXTransformer.js"></script>
  <script src="data/story.js"></script>
  <script src="http://code.responsivevoice.org/responsivevoice.js"></script>
  <script type="text/jsx">

var colors = {
  blue: "#33b5e5",
  gray: "rgba(99,99,99,51)",
  green: "#99cc00",
  red: "#ff4444",
  blue_dark: "#0099cc",
  green_dark: "#669900",
  red_dark: "#cc0000",
  purple: "#aa66cc",
  orange: "#ffbb33",
  orange_dark: "#ff8800",
  blue_bright: "#00ddff",
  gray_bright: "rgba(204,204,204,51)",
} //=>use this:http://www.google.fr/design/spec/style/color.html

var Box = React.createClass({
  render:function(){
    var style={
      backgroundColor:colors[this.props.color]
    }
    return <div
      className="box"
      style={style}
      onClick={this.props.onClick}
      >
      <span className="backtext">{this.props.backText}</span>
      <div className="center">
        <span className="text">{this.props.text}</span>
      </div>
      </div>
  }
})

var Grid = React.createClass({
  render:function(){
    var choices = this.props.choices;
    return (<div className="full">
          {choices.A}
          {choices.B}
          {choices.C}
          {choices.D}
        </div>);
  }    
})

var PauseMenu = React.createClass({
  goBack:function(){
    this.props.toogleMenu();
    window.history.back();
  },
  exit:function(){
    window.location.hash = ""
  },
  render: function(){
    choices = {
      A: (<Box color="green" text="REPEAT"
        onClick={this.props.toogleMenu} />),
      B: (<Box color="green_dark" text="UNDO"
        onClick={this.goBack}/>),
      C: (<Box color="green_dark" text="EXIT"
        onClick={this.exit}/>),
      D: (<Box color="green" text="CONTINUE"
        onClick={this.props.toogleMenu} />)
    }
    return <Grid choices={choices} />;
  }
})

var Story = React.createClass({
  getInitialState: function(){
    return {showMenu:false}
  },
  toogleMenu: function(e){
    responsiveVoice.cancel();
    this.setState({showMenu:!this.state.showMenu});
  },
  render: function() {
    if(this.state.showMenu){
      return <PauseMenu toogleMenu={this.toogleMenu}/>
    }
    var now = this.props.story[this.props.state];
    document.title = now.text
    var voice = "French Female";
    if(now.voice != undefined){
      voice = now.voice;
    }
    responsiveVoice.speak(now.text, voice);
    var box = function(i,color, backtext){
      if(now.choices.length > i){
        var choice = now.choices[i];
        return (<Box
          color={color}
          onClick={this.props.onStateChanged.bind(null,choice.next)}
          text={choice.message}
          backText={backtext}/>)
      }
      return <Box color={color} />
    }.bind(this)
    var choices = {
      A: box(0,"blue","A"),
      B: box(1,"green","B"),
      C: box(2,"orange","C"),
      D: <Box color="red" text="MENU"
        onClick={this.toogleMenu}/>,
    }
    return <Grid choices={choices} />;
  }
  })


var Menu = React.createClass({
  render: function(){
    choices = {
      A: (<Box color="blue" text="Adventure"/>),
      B: (<Box color="blue_dark" text="LIBRARY"
          onClick={this.props.changeState.bind(null,'select')}/>),
      C: (<Box color="blue_dark" text="MAKE YOUR OWN"
        onClick={this.props.changeState.bind(null,'editor')}/>),
      D: (<Box color="blue" text=""/>),
    };
    return <Grid choices={choices} />;
  }
})

var Select = React.createClass({
  render: function(){
    var stories = Object.keys(__STORIES__).sort()
    var box = function(i,color, backtext){
      if(stories.length > i){
        var story = stories[i];
        return (<Box
          color={color}
          onClick={this.props.onStateChanged.bind(null,"start")}
          text={story}
          backText={backtext}/>)
      }
      return <Box color={color} />
    }.bind(this)
    choices = {
      A: box(0,"red_dark",""),
      B: box(1,"red",""),
      C: box(2,"red",""),
      D: box(2,"red_dark",""),
    };
    return <Grid choices={choices} />;
  }
})

var Editor = React.createClass({
  render: function(){
    return <pre>  <h1>  Editor coming soon!</h1></pre>
  }
})

var App = React.createClass({
  changeState: function(next){
    responsiveVoice.cancel();
    window.location.hash = next;
  },
  render: function() {
    if(this.props.state == 'menu'){
      return <Menu changeState={this.changeState}/>
    }
    if(this.props.state == 'select'){
      return <Select changeState={this.changeState}
        onStateChanged={this.changeState}/>
    }
    var story = __STORIES__["Camille"];
    if(this.props.state == 'editor'){
      return <Editor story={story} />
    }
    return (<div className="full">
      <Story story={story} state={this.props.state}
        onStateChanged={this.changeState}/>
    </div>);
  }
});


function render () {
  var route = window.location.hash.substr(1);
  if(route == ''){
    route = "menu";
  }
  console.log('route',route)
  React.render(
    <App state={route}/>,
    document.getElementById('content')
    );
}

window.addEventListener('hashchange', render);
setTimeout(render, 0); //1000 for the first speech to work, 0 if you don't care
  </script>
</body>
</html>