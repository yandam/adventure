<!DOCTYPE html>
<html>
<head>
 <meta charset="utf-8">
 <title>Adventure</title>
 <link rel="stylesheet" href="css/normalize.css">
 <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div id="content" class="full">Ooops, something wrong happened!</div>
  <script src="react/build/react.min.js"></script>
  <script src="react/build/JSXTransformer.js"></script>
  <script src="data/story.js"></script>
  <script type="text/jsx">

var colors = {
  blue:"#79b5d2",
  red:"#d27979",
  violet:"#d279d2",
  green:"#97d279",
}

  var Box = React.createClass({
    render:function(){
      var style={
        backgroundColor:colors[this.props.color]
      }
      return <div
        className="box"
        style={style}
        onClick={this.props.onClick}
        ><span className="text">{this.props.text}</span></div>
    }
  })

  var Grid = React.createClass({
  render:function(){
    var choices = this.props.choices;
    return (<div className="full">
          {choices.A}
          {choices.B}
          {choices.C}
          {choices.D}
        </div>);
  }    
  })

  var Menu = React.createClass({
    render: function(){
      choices = {
        A: (<Box color="blue" text="REPEAT"/>),
        B: (<Box color="red" text="UNDO"/>),
        C: (<Box color="red" text="EXIT"/>),
        D: (<Box color="blue" text="CONTINUE"
          onClick={this.props.toogleMenu} />)
      }
      return <Grid choices={choices} />;
    }
  })

  var Story = React.createClass({
    getInitialState: function(){
      return {showMenu:false}
    },
    toogleMenu: function(){
      this.setState({showMenu:!this.state.showMenu});
    },
      render: function() {
        if(this.state.showMenu){
          return <Menu toogleMenu={this.toogleMenu}/>
        }
        var now = this.props.story[this.props.state];
        document.title = now.text
        var box = function(i,color){
          if(now.choices.length > i){
            var choice = now.choices[i];
            return (<Box
              color={color}
              onClick={this.props.onStateChanged.bind(null,choice.next)}
              text={choice.message}/>)
          }
          return <Box color={color} />
        }.bind(this)
        var choices = {
          A: box(0,"red"),
          B: box(1,"green"),
          C: box(2,"blue"),
          D: <Box color="violet" text="MENU"
            onClick={this.toogleMenu}/>,
        }
        return <Grid choices={choices} />;
      }
    })

    var App = React.createClass({
      changeState: function(next){
        window.location.hash = next;
      },
      render: function() {
        return (<div className="full">
          <Story story={__STORY__} state={this.props.state} onStateChanged={this.changeState}/>
        </div>);
      }
    });


function render () {
  var route = window.location.hash.substr(1);
  console.log('route',route);
  if(route == ''){
    route = "start";
  }
  React.render(
    <App state={route} />,
    document.getElementById('content')
    );
}

window.addEventListener('hashchange', render);
render(); 
  </script>
</body>
</html>